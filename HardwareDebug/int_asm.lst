   1                             	# 1 "../kernel/sysdepend/cpu/core/rxv2/int_asm.S"
   1                             	﻿/*
   0                             	
   0                             	
   0                             	
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.00.01
   4                             	 *
   5                             	 *    Copyright (C) 2006-2020 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2020/05/29.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	#include <sys/machine.h>
   1                             	/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.0 BSP
   4                             	 *
   5                             	 *    Copyright (C) 2021-2022 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2022/04.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	machine.h
  16                             	 *	Machine type definition 
  17                             	 */
  18                             	
  19                             	#ifndef __SYS_MACHINE_H__
  20                             	#define __SYS_MACHINE_H__
  21                             	
  22                             	/* ===== System dependencies definitions ================================ */
  23                             	#include <config.h>
   1                             	/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.00.05
   4                             	 *
   5                             	 *    Copyright (C) 2006-2021 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2021/11.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	config.h
  16                             	 *	User Configuration Definition
  17                             	 */
  18                             	
  19                             	#ifndef __TK_CONFIG__
  20                             	#define __TK_CONFIG__
  21                             	
  22                             	/*---------------------------------------------------------------------- */
  23                             	/*  Target Name
  24                             		Define the system target name. Alternatively, define the target name 
  25                             		in the development environment.
  26                             	 */
  27                             	//#define _IOTE_M367_
  28                             	//#define _IOTE_RX231_
  29                             	//#define _IOTE_STM32L4_
  30                             	//#define _IOTE_RZA2M_
  31                             	
  32                             	/*---------------------------------------------------------------------- */
  33                             	/* SYSCONF : micro T-Kernel system configuration
  34                             	 */
  35                             	
  36                             	#define	CNF_SYSTEMAREA_TOP	0	/* 0: Use system default address */
  37                             	#define CNF_SYSTEMAREA_END	0	/* 0: Use system default address */
  38                             	
  39                             	#define	CNF_MAX_TSKPRI		32	/* Task Max priority */
  40                             	
  41                             	#define CNF_TIMER_PERIOD	10	/* System timer period */
  42                             	
  43                             	/* Maximum number of kernel objects */
  44                             	#define CNF_MAX_TSKID		32	/* Task */
  45                             	#define CNF_MAX_SEMID		16	/* Semaphore */
  46                             	#define CNF_MAX_FLGID		16	/* Event flag */
  47                             	#define CNF_MAX_MBXID		8	/* Mailbox*/
  48                             	#define CNF_MAX_MTXID		4	/* Mutex */
  49                             	#define CNF_MAX_MBFID		8	/* Message buffer */
  50                             	#define CNF_MAX_MPLID		4	/* Memory pool */
  51                             	#define CNF_MAX_MPFID		8	/* Fixed size memory pool */
  52                             	#define CNF_MAX_CYCID		4	/* Cyclic handler */
  53                             	#define CNF_MAX_ALMID		8	/* Alarm handler */
  54                             	
  55                             	/* Device configuration */
  56                             	#define CNF_MAX_REGDEV		(8)	/* Max registered device */
  57                             	#define CNF_MAX_OPNDEV		(16)	/* Max open device */
  58                             	#define CNF_MAX_REQDEV		(16)	/* Max request device */
  59                             	#define CNF_DEVT_MBFSZ0		(-1)	/* message buffer size for event notification */
  60                             	#define CNF_DEVT_MBFSZ1		(-1)	/* message max size for event notification */
  61                             	
  62                             	/* Version Number */
  63                             	#define CNF_VER_MAKER		0
  64                             	#define CNF_VER_PRID		0
  65                             	#define CNF_VER_PRVER		3
  66                             	#define CNF_VER_PRNO1		0
  67                             	#define CNF_VER_PRNO2		0
  68                             	#define CNF_VER_PRNO3		0
  69                             	#define CNF_VER_PRNO4		0
  70                             	
  71                             	
  72                             	/*---------------------------------------------------------------------- */
  73                             	/* Backwards compatible api support 
  74                             	 *      micro T-Kernel2.0 API support (Rendezvous)
  75                             	 */
  76                             	#define USE_LEGACY_API		(0)	/* 1: Valid  0: Invalid */
  77                             	#define CNF_MAX_PORID		(0)	/* Maximum number of Rendezvous */
  78                             	
  79                             	
  80                             	/*---------------------------------------------------------------------- */
  81                             	/* Stack size definition
  82                             	 */
  83                             	#define CNF_EXC_STACK_SIZE	(2048)	/* Exception stack size */
  84                             	#define	CNF_TMP_STACK_SIZE	(256)	/* Temporary stack size */
  85                             	
  86                             	
  87                             	/*---------------------------------------------------------------------- */
  88                             	/* System function selection
  89                             		1: Use function.  0: No use function.
  90                             	 */
  91                             	#define USE_NOINIT		(0)	/* Use zero-clear bss section */
  92                             	#define USE_IMALLOC		(1)	/* Use dynamic memory allocation */
  93                             	#define USE_SHUTDOWN		(1)	/* Use System shutdown */
  94                             	#define USE_STATIC_IVT		(0)	/* Use static interrupt vector table */
  95                             	
  96                             	
  97                             	/*---------------------------------------------------------------------- */
  98                             	/* Check API parameter
  99                             	 *   1: Check parameter  0: Do not check parameter
 100                             	 */
 101                             	#define CHK_NOSPT		(1)	/* Check unsupported function (E_NOSPT) */
 102                             	#define CHK_RSATR		(1)	/* Check reservation attribute error (E_RSATR) */
 103                             	#define CHK_PAR			(1)	/* Check parameter (E_PAR) */
 104                             	#define CHK_ID			(1)	/* Check object ID range (E_ID) */
 105                             	#define CHK_OACV		(1)	/* Check Object Access Violation (E_OACV) */
 106                             	#define CHK_CTX			(1)	/* Check whether task-independent part is running (E_CTX) */
 107                             	#define CHK_CTX1		(1)	/* Check dispatch disable part */
 108                             	#define CHK_CTX2		(1)	/* Check task independent part */
 109                             	#define CHK_SELF		(1)	/* Check if its own task is specified (E_OBJ) */
 110                             	
 111                             	#define	CHK_TKERNEL_CONST	(1)	/* Check const-type parameter */
 112                             	
 113                             	/*---------------------------------------------------------------------- */
 114                             	/* User initialization program (UserInit)
 115                             	 *
 116                             	 */
 117                             	#define	USE_USERINIT		(0)	/*  1: Use UserInit  0: Do not use UserInit */
 118                             	#define RI_USERINIT		(0)	/* UserInit start address */
 119                             	
 120                             	
 121                             	/*---------------------------------------------------------------------- */
 122                             	/* Debugger support function
 123                             	 *   1: Valid  0: Invalid
 124                             	 */
 125                             	#define USE_DBGSPT		(0)	/* Use mT-Kernel/DS */
 126                             	#define USE_OBJECT_NAME		(0)	/* Use DS object name */
 127                             	
 128                             	#define OBJECT_NAME_LENGTH	(8)	/* DS Object name length */
 129                             	
 130                             	/*---------------------------------------------------------------------- */
 131                             	/* Use T-Monitor Compatible API Library  & Message to terminal.
 132                             	　*  1: Valid  0: Invalid
 133                             	 */
 134                             	#define	USE_TMONITOR		(1)	/* T-Monitor API */
 135                             	#define USE_SYSTEM_MESSAGE	(1)	/* System Message */
 136                             	#define USE_EXCEPTION_DBG_MSG	(1)	/* Excepttion debug message */
 137                             	#define USE_TASK_DBG_MSG	(0)	/* Tsak debug message */
 138                             	
 139                             	/*---------------------------------------------------------------------- */
 140                             	/* Use Co-Processor.
 141                             	　*  1: Valid  0: Invalid
 142                             	 */
 143                             	#define	USE_FPU			(0)	/* Use FPU */
 144                             	#define	USE_DSP			(0)	/* Use DSP */
 145                             	
 146                             	/*---------------------------------------------------------------------- */
 147                             	/* Use Physical timer.
 148                             	　*  1: Valid  0: Invalid
 149                             	 */
 150                             	#define USE_PTMR		(1)	/* Use Physical timer */
 151                             	
 152                             	/*---------------------------------------------------------------------- */
 153                             	/* Use Sample device driver.
 154                             	　*  1: Valid  0: Invalid
 155                             	 */
 156                             	#define USE_SDEV_DRV		(1)	/* Use Sample device driver */
 157                             	
 158                             	/*---------------------------------------------------------------------- */
 159                             	/*
 160                             	 *	Use function Definition
 161                             	 */
 162                             	#include "config_func.h"
   1                             	/*
 163                             	
  24                             	
  25                             	#ifdef _IOTE_M367_
  26                             	#include "sysdepend/iote_m367/machine.h"
  27                             	#define Csym(sym) sym
  28                             	#endif
  29                             	
  30                             	#ifdef _IOTE_STM32L4_
  31                             	#include "sysdepend/iote_stm32l4/machine.h"
  32                             	#define Csym(sym) sym
  33                             	#endif
  34                             	
  35                             	#ifdef _IOTE_RX231_
  36                             	#include "sysdepend/iote_rx231/machine.h"
  37                             	#define Csym(sym) _##sym
  38                             	#endif
  39                             	
  40                             	#ifdef _IOTE_RZA2M_
  41                             	#include "sysdepend/iote_rza2m/machine.h"
  42                             	#define Csym(sym) sym
  43                             	#endif
  44                             	
  45                             	/* ----- μT-Kernel BSP ------------------------------------------------- */
  46                             	#ifdef _NUCLEO_L476_
  47                             	#include "sysdepend/nucleo_l476/machine.h"
  48                             	#define Csym(sym) sym
  49                             	#endif
  50                             	
  51                             	#ifdef _NUCLEO_H723_
  52                             	#include "sysdepend/nucleo_h723/machine.h"
  53                             	#define Csym(sym) sym
  54                             	#endif
  55                             	
  56                             	#ifdef _RTB_RX65N_
  57                             	#include "sysdepend/rtb_rx65n/machine.h"
   1                             	/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.0 BSP
   4                             	 *
   5                             	 *    Copyright (C) 2022 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2022/04.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	machine.h
  16                             	 *
  17                             	 *	Machine type definition (Renesas Target Board for RX65N depended)
  18                             	 */
  19                             	
  20                             	#ifndef __SYS_SYSDEPEND_MACHINE_H__
  21                             	#define __SYS_SYSDEPEND_MACHINE_H__
  22                             	
  23                             	/*
  24                             	 * [TYPE]_[CPU]		TARGET SYSTEM
  25                             	 * CPU_xxxx		CPU type
  26                             	 * CPU_CORE_xxx		CPU core type
  27                             	 */
  28                             	
  29                             	/* ----- Renesas Target Board for RX65N (CPU: RX65N) definition ----- */
  30                             	
  31                             	#define RTB_RX65N		1		/* Target system : Target Board */
  32                             	#define CPU_RX65N		1		/* Target CPU : Renesas RX65N */
  33                             	#define CPU_CORE_RXV2		1		/* Target CPU-Core : RX200 series*/
  34                             	
  35                             	#define TARGET_DIR		rtb_rx65n	/* Sysdepend-Directory name */
  36                             	
  37                             	/*
  38                             	 **** CPU-depeneded profile (RX65N)
  39                             	 */
  40                             	#include "../cpu/rx65n/machine.h"
   1                             	/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.00.06.B0
   4                             	 *
   5                             	 *    Copyright (C) 2022 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2022/04.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	machine_depend.h
  16                             	 *
  17                             	 *	Machine type definition (RX65N depended)
  18                             	 */
  19                             	
  20                             	#ifndef __SYS_SYSDEPEND_MACHINE_CPU_H__
  21                             	#define __SYS_SYSDEPEND_MACHINE_CPU_H__
  22                             	
  23                             	/*
  24                             	 **** CPU core-depeneded profile (RXv2)
  25                             	 */
  26                             	
  27                             	#include "../core/rxv2/machine.h"
   1                             	/*
  28                             	
  41                             	
  58                             	#define Csym(sym) _##sym
  15                             	#ifdef CPU_CORE_RXV2
  16                             	/*
  17                             	 *	int_asm.S (RXv2)
  18                             	 *	Interrupt control assembler routine
  19                             	 */
  20                             	#define	_in_asm_source_
  21                             	
  22                             	#include <sys/sysdef.h>
   1                             	/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.00.00
   4                             	 *
   5                             	 *    Copyright (C) 2006-2019 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.1.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2019/12/11.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	sysdef.h
  16                             	 *
  17                             	 *	System dependencies definition.
  18                             	 *	Included also from assembler program.
  19                             	 */
  20                             	
  21                             	#ifndef __SYS_SYSDEF_H__
  22                             	#define __SYS_SYSDEF_H__
  23                             	
  24                             	/* System dependencies */
  25                             	#define SYSDEF_PATH_(a)		#a
  26                             	#define SYSDEF_PATH(a)		SYSDEF_PATH_(a)
  27                             	#define SYSDEF_SYSDEP()		SYSDEF_PATH(sysdepend/TARGET_DIR/sysdef.h)
  28                             	#include SYSDEF_SYSDEP()
   1                             	/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.0 BSP
   4                             	 *
   5                             	 *    Copyright (C) 2022 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2022/04.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	sysdef.h
  16                             	 *
  17                             	 *	System dependencies definition (Renesas Target Board for RX65N depended)
  18                             	 *	Included also from assembler program.
  19                             	 */
  20                             	
  21                             	#ifndef __SYS_SYSDEF_DEPEND_H__
  22                             	#define __SYS_SYSDEF_DEPEND_H__
  23                             	
  24                             	
  25                             	/* CPU-dependent definition */
  26                             	#include "../cpu/rx65n/sysdef.h"
   1                             	﻿/*
   2                             	 *----------------------------------------------------------------------
   3                             	 *    micro T-Kernel 3.00.06.B0
   4                             	 *
   5                             	 *    Copyright (C) 2022 by Ken Sakamura.
   6                             	 *    This software is distributed under the T-License 2.2.
   7                             	 *----------------------------------------------------------------------
   8                             	 *
   9                             	 *    Released by TRON Forum(http://www.tron.org) at 2022/04.
  10                             	 *
  11                             	 *----------------------------------------------------------------------
  12                             	 */
  13                             	
  14                             	/*
  15                             	 *	sysdef.h
  16                             	 *
  17                             	 *	System dependencies definition (RX65N CPU depended)
  18                             	 *	Included also from assembler program.
  19                             	 */
  20                             	
  21                             	#ifndef __TK_SYSDEF_DEPEND_CPU_H__
  22                             	#define __TK_SYSDEF_DEPEND_CPU_H__
  23                             	
  24                             	
  25                             	/* CPU Core-dependent definition */
  26                             	#include "../core/rxv2/sysdef.h"
   1                             	/*
  27                             	
  27                             	
  29                             	
  23                             	
  24                             		.section .text
  25                             		.globl Csym(knl_hll_inthdr)
  26                             		.globl Csym(knl_return_inthdr)
  27                             	
  28                             	/* ------------------------------------------------------------------------ */
  29                             	/*
  30                             	 * HLL(High level programming language) Interrupt Handler
  31                             	 *
  32                             	 */
  33                             		.extern Csym(knl_hll_inthdr_ram)
  34                             		.extern Csym(knl_taskindp)
  35                             		.extern Csym(knl_int_nest)
  36                             		.extern Csym(ret_int_dispatch)
  37                             	
  38                             	Csym(knl_hll_inthdr):
  39                             		/* During interrupt disable PSW.I=0 */
  40 0000 6E EF                   		pushm	r14-r15				/* R1-R2 are already saved */
  41 0002 6E 37                   		pushm	r3-r7
  42                             	
  43                             	#if	USE_FPU
  44                             		mvfc	fpsw, r3
  45                             		push.l	r3
  46                             	#endif
  47                             	
  48 0004 FB 62 00 00 00 00       		mov.l	#Csym(knl_taskindp), r6		/* enter task independent mode */
  49 000a EC 67                   		mov.l	[r6], r7
  50 000c 62 17                   		add	#1, r7
  51 000e E3 67                   		mov.l	r7, [r6]
  52                             	
  53 0010 FB 42 00 00 00 00       		mov.l	#Csym(knl_int_nest), r4		/* interrupt nest count */
  54 0016 EC 43                   		mov.l	[r4], r3
  55 0018 EF 36                   		mov.l	r3, r6
  56 001a 62 13                   		add	#1, r3
  57 001c E3 43                   		mov.l	r3, [r4]
  58                             	
  59 001e 61 06                   		cmp	#0, r6
  60 0020 21 0C                   		bne	l_no_change_sp			/* multiple interrupt */
  61 0022 EF 03                   		mov.l	r0, r3
  62 0024 FB 0E 00 00 04          		mov.l	#INTSTACK_TOP, r0		/* change to ISP */
  63 0029 FD 26 03                		mov.l	r3, [-r0]			/* SSP save */
  64                             	l_no_change_sp:
  65                             	
  66 002c 7F A8                   		setpsw	I				/* Interrupt enable */
  67                             	
  68                             	#if USE_STATIC_IVT
  69                             		mov.l	#Csym(knl_hll_inthdr_rom), r2	/* call knl_hll_inthdr_rom[n](dintno) */
  70                             	#else
  71 002e FB 22 00 00 00 00       		mov.l	#Csym(knl_hll_inthdr_ram), r2	/* call knl_hll_inthdr_rom[n](dintno) */
  72                             	#endif
  73 0034 FE 61 24                		mov.l	[r1, r2], r4			/* r1 is dintno. */
  74 0037 7F 14                   		jsr	r4
  75                             	
  76 0039 7F B8                   		clrpsw	I				/* Interrupt disable */
  77                             	
  78                             		; During interrupt disable PSW.I=0
  79 003b 61 06                   		cmp	#0, r6
  80 003d 1E                      		bne	l_no_change_sp2			/* multiple interrupt */
  81                             	
  82 003e FD 2A 03                		mov.l	[r0+], r3			/* r3 = SSP */
  83 0041 EF 30                   		mov.l	r3, r0
  84                             	l_no_change_sp2:
  85 0043 60 17                   		sub	#1, r7
  86 0045 FB 62 00 00 00 00       		mov.l	#Csym(knl_taskindp), r6
  87 004b E3 67                   		mov.l	r7, [r6]
  88                             	
  89                             	#if	USE_FPU
  90                             		pop	r3
  91                             		mvtc	r3, fpsw
  92                             	#endif
  93 004d 6F 37                   		popm	r3-r7
  94 004f 6F EF                   		popm	r14-r15
  95                             	
  96                             		/* bra  Cym(knl_return_inthdr) */
  97                             	
  98                             	/* ------------------------------------------------------------------------ */
  99                             	/*
 100                             	 * knl_return_inthdr()  Called from tk_ret_int call.
 101                             	 *    This call can be called only from a handler with the assembler attribute.
 102                             	 */
 103                             	Csym(knl_return_inthdr):
 104                             		/* During interrupt disable PSW.I=0 */
 105 0051 FB 12 00 00 00 00       		mov.l	#Csym(knl_int_nest), r1		/* Is it a nesting interrupt? */
 106 0057 EC 12                   		mov.l	[r1], r2
 107 0059 60 12                   		sub	#1, r2
 108 005b E3 12                   		mov.l	r2, [r1]
 109 005d 21 27                   		bne	l_nodispatch
 110                             	
 111 005f FB 12 00 00 00 00       		mov.l	#Csym(knl_dispatch_disabled), r1	/* Is it during dispatch disable? */
 112 0065 EC 11                   		mov.l	[r1], r1
 113 0067 61 01                   		cmp	#0, r1
 114 0069 21 1B                   		bne	l_nodispatch
 115                             	
 116 006b FB 12 00 00 00 00       		mov.l	#Csym(knl_ctxtsk), r1		/* Is dispatch required? */
 117 0071 EC 11                   		mov.l	[r1], r1
 118 0073 FB 22 00 00 00 00       		mov.l	#Csym(knl_schedtsk), r2
 119 0079 EC 22                   		mov.l	[r2], r2
 120 007b 47 12                   		cmp	r1, r2
 121 007d 17                      		beq	l_nodispatch
 122                             	
 123 007e 6F 12                   		popm	r1-r2				/* R1, R2 restore */
 124 0080 04 00 00 00             		bra	Csym(ret_int_dispatch)		/* To dispatch processing */
 125                             	
 126                             	l_nodispatch:					/* Dispatch not required */
 127 0084 6F 12                   		popm	r1-r2				/* R1, R2 restore */
 128 0086 7F 95                   		rte
 129                             	
 130                             		.end
